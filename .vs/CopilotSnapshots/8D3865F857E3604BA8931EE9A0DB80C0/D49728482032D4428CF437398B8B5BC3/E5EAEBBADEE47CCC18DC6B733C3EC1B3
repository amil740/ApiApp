using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;

namespace ApiProject.Controllers;

[Route("api/[controller]")]
[ApiController]
public class EventController : ControllerBase
{
    private readonly Data.AppDbContext _context;
    private readonly IMapper _mapper;
    private readonly IValidator<EventCreateDto> _createValidator;
    private readonly IValidator<EventBannerUpdateDto> _bannerValidator;

    public EventController(Data.AppDbContext context, IMapper mapper, IValidator<EventCreateDto> createValidator, IValidator<EventBannerUpdateDto> bannerValidator)
    {
        _context = context;
        _mapper = mapper;
        _createValidator = createValidator;
        _bannerValidator = bannerValidator;
    }
    [HttpGet]
    public async Task<ActionResult<IEnumerable<EventDto>>> GetAll()
    {
        var events = await _context.Events.Include(e => e.Organizer).ToListAsync();
        return Ok(_mapper.Map<List<EventDto>>(events));
    }
    [HttpPost]
    public async Task<ActionResult<EventDto>> Create([FromBody] EventCreateDto dto)
    {
        ValidationResult result = await _createValidator.ValidateAsync(dto);
        if (!result.IsValid)
            return BadRequest(result.Errors);

        var entity = _mapper.Map<Event>(dto);
        _context.Events.Add(entity);
        await _context.SaveChangesAsync();

        var eventDto = _mapper.Map<EventDto>(entity);
        return CreatedAtAction(nameof(GetAll), new { id = entity.Id }, eventDto);
    }
    [HttpPost("{id}/banner")]
    public async Task<IActionResult> UploadBanner(int id, [FromForm] EventBannerUpdateDto dto)
    {
        ValidationResult result = await _bannerValidator.ValidateAsync(dto);
        if (!result.IsValid)
            return BadRequest(result.Errors);

        var ev = await _context.Events.FindAsync(id);
        if (ev == null) return NotFound();

        ev.BannerImageUrl = dto.BannerImageUrl;
        await _context.SaveChangesAsync();
        return NoContent();
    }
}
