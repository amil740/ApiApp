using Microsoft.AspNetCore.Mvc;
using ApiProject.DTOs.Organizer;
using ApiProject.Models;
using AutoMapper;
using Microsoft.EntityFrameworkCore;
using ApiProject.Data;

namespace ApiProject.Controllers;

[ApiController]
[Route("api/organizers")]
public class OrganizerController : ControllerBase
{
    private readonly AppDbContext _context;
    private readonly IMapper _mapper;

    public OrganizerController(AppDbContext context, IMapper mapper)
    {
        _context = context;
        _mapper = mapper;
    }

    [HttpGet]
    public async Task<IActionResult> GetAll()
    {
        var organizers = await _context.Organizers.Include(o => o.Event).ToListAsync();
        var organizerDtos = _mapper.Map<List<OrganizerDto>>(organizers);
        return Ok(organizerDtos);
    }

    [HttpPost]
    public async Task<IActionResult> Create(CreateOrganizerDto dto)
    {
        if (!ModelState.IsValid)
            return BadRequest(ModelState);

        var organizer = _mapper.Map<Organizer>(dto);
        organizer.LogoUrl ??= string.Empty;
        organizer.Phone ??= string.Empty;

        try
        {
            await _context.Organizers.AddAsync(organizer);
            await _context.SaveChangesAsync();
        }
        catch (DbUpdateException ex)
        {
            return StatusCode(500, "Database error while creating organizer: " + ex.Message);
        }

        var organizerDto = _mapper.Map<OrganizerDto>(organizer);
        return Created($"/api/organizers/{organizer.Id}", organizerDto);
    }

    [HttpPost("{id}/logo")]
    public async Task<IActionResult> UploadLogo(int id, [FromBody] OrganizerLogoUpdateDto dto)
    {
        if (!ModelState.IsValid)
            return BadRequest(ModelState);

        var organizer = await _context.Organizers.FindAsync(id);
        if (organizer == null)
            return NotFound("Organizer tapılmadı");

        organizer.LogoUrl = dto.LogoUrl;

        try
        {
            await _context.SaveChangesAsync();
        }
        catch (DbUpdateException ex)
        {
            return StatusCode(500, "Database error while updating logo: " + ex.Message);
        }

        return NoContent();
    }
}

